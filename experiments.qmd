---
title: "Fair clustering experiments"
execute:
  echo: false
  warning: false
  message: false
---

```{r}
library(tidyverse)
library(ggpattern)
theme_set(theme_bw() + theme(legend.position="bottom"))

imgdir <- "imgs"

imgpath <- function(key) {
  str_c(imgdir, key, "clustering.png", sep="/")
}

load_data <- function() {
  con <- DBI::dbConnect(RSQLite::SQLite(), "results.db")

  results <- tbl(con, sql("select *, json_extract(params, '$.tau') / k as tau, cast(additional_metrics -> '$.coreset_radius' as real) as coreset_radius from results")) |> 
    filter(delta == 0) |>
    inner_join(tbl(con, "dataset_stats")) |>
    collect() |>
    mutate(
      timeout_s = if_else(time_s > 30*60, 30*60, timeout_s),
      timed_out = !is.na(timeout_s),
      time_s = if_else(timed_out, timeout_s, time_s),
      img_path = imgpath(hdf5_key),
      coreset_size_frac = tau * k / n,
      dataset = fct_reorder(dataset, desc(n))
    ) |>
    group_by(dataset, k) |>
    mutate(scaled_radius = radius / min(radius)) |>
    ungroup()

  DBI::dbDisconnect(con)
  results
}

results <- load_data()
```

```{r}
load_data() |>
  distinct(dataset, n, dimensions) |>
  arrange(desc(n))
```

```{r}
#| column: screen
#| out-width: "100%"
#| fig-width: 15
#| fig-height: 15
results |>
  ggplot(aes(scaled_radius, time_s, color=algorithm, shape=algorithm)) +
  geom_point(data=~ filter(., timed_out), shape=21, color="black", fill="white", size=4) +
  geom_point() +
  facet_grid(vars(dataset), vars(k))
```

```{r}
load_data() |>
  mutate(tau = if_else(is.na(tau), 0, tau)) |>
  ggplot(aes(k, radius, color=algorithm)) +
  geom_line(data=~filter(., algorithm != "coreset-fair-k-center")) +
  geom_point(data=~filter(., algorithm != "coreset-fair-k-center")) +
  geom_line(
    data=~filter(., algorithm == "coreset-fair-k-center"),
    mapping=aes(linetype=factor(tau)),
    stat="summary",
    fun=mean
  ) +
  geom_point(
    data=~filter(., algorithm == "coreset-fair-k-center"),
    mapping=aes(shape=factor(tau)),
    stat="summary",
    fun=mean
  ) +
  scale_y_continuous(limits=c(0,NA)) +
  facet_wrap(vars(dataset), scale="free_y")
```

```{r}
load_data() |>
  ggplot(aes(tau, coreset_radius, color=factor(k))) +
  geom_line(data=~drop_na(., coreset_radius)) +
  facet_grid(vars(dataset), vars(factor(k)), scales="free")
```

```{r}
#| column: screen
#| out-width: "100%"
#| fig-width: 15
#| fig-height: 15
load_data() |>
  ggplot(aes(coreset_size_frac, scaled_radius, color=factor(k))) +
  geom_line(data=~drop_na(., coreset_radius), stat="summary") +
  geom_point(data=~drop_na(., coreset_radius)) +
  geom_hline(
    aes(yintercept = scaled_radius),
    data=~filter(., algorithm == "bera-et-al-k-center"), 
    color="black"
  ) +
  scale_y_continuous(limits=c(1,NA)) +
  scale_x_continuous(limits=c(0,1), labels=scales::percent) +
  facet_grid(vars(dataset), vars(factor(k)), scales="free")
```

